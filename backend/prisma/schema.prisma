generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String              @id @default(cuid())
  clerkId             String              @unique
  email               String              @unique
  company             Company?
  linkedinToken       String?             // Deprecated - use PlatformConnection
  platformConnections PlatformConnection[]
  consent             UserConsent?
  deletionRequests    DeletionRequest[]
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
}

model UserConsent {
  id                  String    @id @default(cuid())
  userId              String    @unique
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  aiProcessingConsent Boolean   @default(false)
  aiConsentGrantedAt  DateTime?
  consentVersion      String    @default("1.0")
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}

model DeletionRequest {
  id               String          @id @default(cuid())
  userId           String
  user             User            @relation(fields: [userId], references: [id])
  zoomUserId       String?
  status           DeletionStatus  @default(PENDING)
  scheduledFor     DateTime
  completedAt      DateTime?
  zoomComplianceId String?
  auditLog         Json?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([status, scheduledFor])
  @@index([zoomUserId])
}

enum DeletionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model Company {
  id                     String   @id @default(cuid())
  userId                 String   @unique
  user                   User     @relation(fields: [userId], references: [id])
  name                   String
  brandVoiceData         Json     // Stores all brand voice analysis
  contentPillars         String   // JSON string for SQLite compatibility
  postingSchedule        Json     // Default posting times
  supportedPlatforms     String   @default("[]") // JSON array of platform types
  platformConfigurations Json?    // Platform-specific settings
  customLinkedInPrompt   String?  // AI-generated custom prompt for LinkedIn post generation
  customHookPrompt       String?  // AI-generated custom prompt for hook generation
  customImagePrompt      String?  // AI-generated custom prompt for image generation
  websiteScreenshotUrl   String?  // URL/path to website screenshot for visual analysis
  meetings               Meeting[]
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

model Meeting {
  id              String         @id @default(cuid())
  companyId       String?
  company         Company?       @relation(fields: [companyId], references: [id])
  sourceId        String         @unique  // Zoom meeting UUID or other source ID (renamed from readaiId)
  sourceType      MeetingSource  @default(ZOOM)
  sourceSessionId String
  sessionSequence Int            @default(1)
  title           String?
  transcript      String
  summary         String?
  actionItems     Json?
  contentHooks    ContentHook[]
  processedStatus ProcessedStatus @default(PENDING)
  processingStep  ProcessingStep? @default(RECEIVED)
  processedAt     DateTime?
  createdAt       DateTime       @default(now())

  @@index([companyId])
  @@index([processedStatus])
  @@index([processingStep])
  @@index([createdAt])
  @@index([companyId, processedStatus])
  @@index([sourceSessionId])
  @@unique([sourceSessionId, sessionSequence])
}

enum MeetingSource {
  ZOOM
  READAI  // Legacy, for backward compatibility during migration
}

model ContentHook {
  id          String        @id @default(cuid())
  meetingId   String
  meeting     Meeting       @relation(fields: [meetingId], references: [id])
  hook        String
  pillar      String?       // Which content pillar this belongs to
  posts       ContentPost[]
  createdAt   DateTime      @default(now())

  @@index([meetingId])
  @@index([pillar])
  @@index([createdAt])
}

model ContentPost {
  id             String      @id @default(cuid())
  hookId         String
  hook           ContentHook @relation(fields: [hookId], references: [id])
  content        String
  imageUrl       String?
  imagePrompt    String?
  status         PostStatus  @default(PENDING)
  scheduledFor   DateTime?
  publishedAt    DateTime?
  rejectionReason String?    // Reason for rejection (e.g., LinkedIn connection issues)
  platformContent Json?      // Store platform-specific data (LinkedIn post IDs, etc.)
  editHistory    Json?       // Track content edits
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@index([hookId])
  @@index([status])
  @@index([createdAt])
  @@index([scheduledFor])
  @@index([hookId, status])
  @@index([status, createdAt])
}

enum PostStatus {
  PENDING
  APPROVED
  SCHEDULED
  PUBLISHED
  REJECTED
}

enum ProcessedStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ProcessingStep {
  RECEIVED
  ANALYZING_BRAND_VOICE
  GENERATING_HOOKS
  WRITING_POSTS
  CREATING_IMAGES
  COMPLETED
}

model PlatformConnection {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id])
  platform          String   // 'linkedin', 'twitter', etc.
  platformUserId    String?  // User ID on the platform
  encryptedToken    String   // Encrypted access token
  refreshToken      String?  // Encrypted refresh token
  expiresAt         DateTime?
  connectionMetadata Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([userId, platform])
}
